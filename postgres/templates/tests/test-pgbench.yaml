apiVersion: v1
kind: Pod
metadata:
  name: {{ include "postgres.fullname" . }}-pgbench-test
  labels:
    {{- include "postgres.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - name: {{ .Chart.Name }}-pgbench
    image: {{ .Values.postgres.image }}
    command: ["/bin/sh","-c"]
    args:
    - |
      set -x -e -o pipefail
      pgbench -i
      pgbench -c 3 -j 2 -T 2
      psql -c checkpoint
    env:
    - name: PGHOST
      value: "pdb"
    - name: PGPORT
      value: "5432"
    - name: PGDATABASE
      value: "postgres"
    - name: PGUSER
      value: "postgres"
    - name: PGPASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "postgres.secret.superuser.password" . }}
          key: POSTGRES_PASSWORD
  restartPolicy: Never
