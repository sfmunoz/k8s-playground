apiVersion: v1
kind: Pod
metadata:
  name: postgres-pgbench-test
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - name: postgres
    image: {{ .Values.postgres.image }}
    command: ["/bin/sh","-c"]
    args:
    - |
      set -x -e -o pipefail
      pgbench -i
      pgbench -c 3 -j 2 -T 2
      psql -c checkpoint
    env:
    - name: PGHOST
      value: "postgres-service"
    - name: PGPORT
      value: "5432"
    - name: PGDATABASE
      value: "postgres"
    - name: PGUSER
      value: "postgres"
    - name: PGPASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres
          key: POSTGRES_PASSWORD
  restartPolicy: Never
