# flatcar

- [References](#references)
- [Config systems](#config-systems)
- [Butane vs Ignition](#butane-vs-ignition)
- [Install ISO (VirtualBox)](#install-iso-virtualbox)
- [K3s install](#k3s-install)
- [OS updates](#os-updates)
  - [OS updates: useful commands](#os-updates-useful-commands)
  - [OS updates: example](#os-updates-example)
  - [OS updates: FAQ](#os-updates-faq)
- [(OLD) Install (VirtualBox)](#old-install-virtualbox)
  - [(OLD) user-configdrive.service](#old-user-configdriveservice)
  - [(OLD) coreos-cloudinit](#old-coreos-cloudinit)

## References

- https://www.flatcar.org/
- https://www.flatcar.org/docs/latest/installing/

## Config systems

Recap:

- Now: **Butane + Ignition**
  - **Butane**: successor of **Container Linux Config**
  - Butane generates Ignition v3+ configurations
  - [Container Linux Config Transpiler](https://www.flatcar.org/docs/latest/provisioning/cl-config/) generates Ignition v2 configurations
- Old: **cloud-config**

https://www.flatcar.org/docs/latest/installing/

> (...)
>
> Flatcar Container Linux is configured at provisioning time. There are two configuration languages to set up Flatcar, aimed at different use cases:
>
> - [Butane Config](https://www.flatcar.org/docs/latest/provisioning/config-transpiler/) Butane is human-readable / writable YAML and must be converted (transpiled) into Ignition V3 config before Flatcar can use it. It’s the successor of [Container Linux Config](https://www.flatcar.org/docs/latest/provisioning/cl-config/) which is also still supported (Butane is not supported for LTS-2022).
> - [Ignition config](https://www.flatcar.org/docs/latest/provisioning/ignition/) is machine-readable JSON fed to Flatcar’s ignition service. Ignition is Flatcars “installation service” which configures a Flatcar instance during provisioning. The config file is passed via the “custom data” or “user data” option of cloud providers, and can be supplied by various mechanisms to private cloud VMs and bare metal. Ignition config is rarely written by a human; it’s usually generated by provisioning automation or transpiled from user-written Butane.
>
> (...)

https://www.flatcar.org/docs/latest/provisioning/cl-config/

> (...)
>
> Previously, the recommended way to provision a Flatcar Container Linux machine was with a cloud-config. These configs would be given to a Flatcar Container Linux machine and a utility called [coreos-cloudinit](https://github.com/kinvolk/coreos-cloudinit) would read this file and apply the configuration on every boot.
>
> For a [number of reasons](https://www.flatcar.org/docs/latest/provisioning/ignition/#ignition-vs-coreos-cloudinit), coreos-cloudinit has been deprecated in favor of Container Linux Configs and Ignition. For help migrating from these legacy cloud-configs to Container Linux Configs, refer to the [migration guide](https://www.flatcar.org/docs/latest/provisioning/cl-config/from-cloud-config/).
>
> (...)

https://www.flatcar.org/docs/latest/provisioning/config-transpiler/

> (...)
>
> **Note**: Butane is utilized to generate Ignition v3+ configurations. If you are still utilizing a version of Container Linux that requires Ignition v2, you can refer to the [Container Linux Config Transpiler](https://www.flatcar.org/docs/latest/provisioning/cl-config/) documentation. This particularly applies to those using the current LTS releases.
>
> (...)

## Butane vs Ignition

Ref: https://www.flatcar.org/docs/latest/installing/

**cl.yaml**:
```yaml
variant: flatcar
version: 1.0.0
systemd:
  units:
    - name: nginx.service
      enabled: true
      contents: |
        [Unit]
        Description=NGINX example
        After=docker.service
        Requires=docker.service
        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker rm --force nginx1
        ExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1
        ExecStop=/usr/bin/docker stop nginx1
        Restart=always
        RestartSec=5s
        [Install]
        WantedBy=multi-user.target
```

Butane → Ignition:
```
cat cl.yaml | docker run --rm -i quay.io/coreos/butane:latest > ignition.json
```

`jq . < ignition.json`:
```json
{
  "ignition": {
    "version": "3.3.0"
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=NGINX example\nAfter=docker.service\nRequires=docker.service\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker rm --force nginx1\nExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1\nExecStop=/usr/bin/docker stop nginx1\nRestart=always\nRestartSec=5s\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "nginx.service"
      }
    ]
  }
}
```

contents:
```
jq -r '.systemd.units[0].contents' < ignition.json
[Unit]
Description=NGINX example
After=docker.service
Requires=docker.service
[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker rm --force nginx1
ExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1
ExecStop=/usr/bin/docker stop nginx1
Restart=always
RestartSec=5s
[Install]
WantedBy=multi-user.target
```

## Install ISO (VirtualBox)

Refs:

- https://www.flatcar.org/docs/latest/installing/bare-metal/booting-with-iso/
- https://www.flatcar.org/docs/latest/installing/bare-metal/installing-to-disk/

**(1)** Butane **cl.yaml** config (at least **core** user with known ssh_authorized_key to be able to access the VM):
```
$ cat cl.yaml
variant: flatcar
version: 1.0.0
passwd:
  users:
  - name: core
    ssh_authorized_keys:
    - "ssh-rsa AAAA..."
```
**(2)** Generate **ignition.json** config out of butane **cl.yaml** config:
```
$ docker run --rm -i quay.io/coreos/butane:latest < cl.yaml > ignition.json
```
**(3)** Start HTTP server on the host (same **ignition.json** folder):
```
$ busybox httpd -p 192.168.56.1:8080 -f -v
```
**(4)** ISO download:
```
$ wget https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_iso_image.iso

$ ls -l flatcar_production_iso_image.iso
-rw------- 1 sfm sfm 462422016 Oct 12 23:32 flatcar_production_iso_image.iso
```
**(5)** VM start:

- ISO: **flatcar_production_iso_image.iso**
- RAM: 2GB
- HD: 8GB

Console:

```
Flatcar Container Linux by Kinvolk stable 4230.2.4
Update Strategy: No Reboots
core@localhost ~ $
```

**(6)** Trigger process on VM (**lsblk** to figure out the device):

> Ref: https://www.flatcar.org/docs/latest/installing/bare-metal/installing-to-disk/

```
core@localhost ~ $ wget http://192.168.56.1:8080/ignition.json

core@localhost ~ $ sudo flatcar-install -d /dev/sda -i ignition.json
(...)
Success! Flatcar Container Linux stable 4230.2.4 is installed on /dev/sda
```
**(7)** Poweroff
```
core@localhost ~ $ sudo poweroff
```
**(8)** Create one copy (or multiple copies) of the HD to start a new VM:
```
$ vboxmanage clonehd hd.vdi hd1.vdi --format VDI
```
**(9)** Create a new VM using **hd1.vdi** (or multiple VMs using the new HDs).

**(10)** Start the new VM (or VMs)

**(11)** Access the VM:
```
$ ssh core@192.168.56.27
(...)
Flatcar Container Linux by Kinvolk stable 4230.2.4
core@localhost ~ $
```

**Alternative**: use the same VM installed if you want to start just one VM and don't want to reuse it

## K3s install

Ready to be used file: [k3s.yaml](k3s.yaml)

> **Notice**: procedure tested on https://vultr.com using **Flatcar Stable x64** version

Butane config (e.g. **cl.yaml**). For vultr ssh key is set using **Server Settings → SSH Keys** option even though it's OK to have it in the butane file:
```yaml
variant: flatcar
version: 1.0.0

systemd:
  units:
    - name: k3s-install.service
      enabled: true
      contents: |
        [Unit]
        Description=K3s install
        Wants=network-online.target
        After=network-online.target
        ConditionFirstBoot=yes
        [Service]
        Type=oneshot
        Restart=on-failure
        RemainAfterExit=true
        ExecStart=/usr/bin/bash -c 'set -e -o pipefail ; curl -sfL https://get.k3s.io | sh -'
        [Install]
        WantedBy=multi-user.target

passwd:
  users:
  - name: core
    ssh_authorized_keys:
    - "ssh-rsa AAAA..."
```

Generate **ignition.json** and use it when creating **Flatcar Stable x64** instance
```
docker run --rm -i quay.io/coreos/butane:latest < cl.yaml > ignition.json
```
k3s-install status:
```
vultr ~ # systemctl status k3s-install -n 10000
● k3s-install.service - K3s install
     Loaded: loaded (/etc/systemd/system/k3s-install.service; enabled; preset: enabled)
     Active: active (exited) since Sat 2025-11-08 19:52:43 UTC; 1min 54s ago
 Invocation: 54d5065ad1a84364a9a7345f139bb1a3
    Process: 1459 ExecStart=/usr/bin/bash -c curl -sfL https://get.k3s.io | sh - (code=exited, status=0/SUCCESS)
   Main PID: 1459 (code=exited, status=0/SUCCESS)
   Mem peak: 147.1M
        CPU: 1.189s

Nov 08 19:52:25 vultr.guest systemd[1]: Starting k3s-install.service - K3s install...
Nov 08 19:52:25 vultr.guest bash[1500]: touch: cannot touch '/usr/local/bin/k3s-ro-test': Read-only file system
Nov 08 19:52:25 vultr.guest bash[1463]: [INFO]  Finding release for channel stable
Nov 08 19:52:26 vultr.guest bash[1463]: [INFO]  Using v1.33.5+k3s1 as release
Nov 08 19:52:26 vultr.guest bash[1463]: [INFO]  Downloading hash https://github.com/k3s-io/k3s/releases/download/v1.33.5+k3s1/sha256sum-amd64.txt
Nov 08 19:52:27 vultr.guest bash[1463]: [INFO]  Downloading binary https://github.com/k3s-io/k3s/releases/download/v1.33.5+k3s1/k3s
Nov 08 19:52:28 vultr.guest bash[1463]: [INFO]  Verifying binary download
Nov 08 19:52:28 vultr.guest bash[1463]: [INFO]  Installing k3s to /opt/bin/k3s
Nov 08 19:52:28 vultr.guest bash[1463]: [INFO]  Finding available k3s-selinux versions
Nov 08 19:52:29 vultr.guest bash[1463]: [WARN]  Please reboot your machine to activate the changes and avoid data loss.
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  Creating /opt/bin/kubectl symlink to k3s
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  Skipping /opt/bin/crictl symlink to k3s, command exists in PATH at /usr/sbin/crictl
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  Skipping /opt/bin/ctr symlink to k3s, command exists in PATH at /usr/sbin/ctr
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  Creating killall script /opt/bin/k3s-killall.sh
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  Creating uninstall script /opt/bin/k3s-uninstall.sh
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
Nov 08 19:52:29 vultr.guest bash[1463]: [INFO]  systemd: Enabling k3s unit
Nov 08 19:52:29 vultr.guest systemctl[1565]: Created symlink '/etc/systemd/system/multi-user.target.wants/k3s.service' → '/etc/systemd/system/k3s.service'.
Nov 08 19:52:30 vultr.guest bash[1463]: [INFO]  systemd: Starting k3s
Nov 08 19:52:43 vultr.guest systemd[1]: Finished k3s-install.service - K3s install.
```
Trying to run it again won't do it:
```
vultr ~ # systemctl stop k3s-install

vultr ~ # systemctl start k3s-install

vultr ~ # systemctl status k3s-install -n 10000
(...)
Nov 08 20:17:56 vultr.guest systemd[1]: k3s-install.service: Deactivated successfully.
Nov 08 20:17:56 vultr.guest systemd[1]: Stopped k3s-install.service - K3s install.
Nov 08 20:18:04 vultr.guest systemd[1]: k3s-install.service - K3s install was skipped because of an unmet condition check (ConditionFirstBoot=yes).
```
After reboot:
```
vultr ~ # systemctl status k3s-install -n 10000
○ k3s-install.service - K3s install
     Loaded: loaded (/etc/systemd/system/k3s-install.service; enabled; preset: enabled)
     Active: inactive (dead)
  Condition: start condition unmet at Sat 2025-11-08 20:19:29 UTC; 21s ago
             └─ ConditionFirstBoot=yes was not met

Nov 08 20:19:29 vultr.guest systemd[1]: k3s-install.service - K3s install was skipped because of an unmet condition check (ConditionFirstBoot=yes).
```
Everything was set:
```
vultr ~ # systemctl status k3s -n 0 | cat
● k3s.service - Lightweight Kubernetes
     Loaded: loaded (/etc/systemd/system/k3s.service; enabled; preset: disabled)
     Active: active (running) since Sat 2025-11-08 20:19:44 UTC; 1min 28s ago
 Invocation: 47f091c93fc84240aa9e8db12020d050
       Docs: https://k3s.io
    Process: 1373 ExecStartPre=/sbin/modprobe br_netfilter (code=exited, status=0/SUCCESS)
    Process: 1376 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
   Main PID: 1381 (k3s-server)
      Tasks: 92
     Memory: 709.4M (peak: 714M)
        CPU: 16.202s
     CGroup: /system.slice/k3s.service
             ├─1381 "/opt/bin/k3s server"
             ├─1405 "containerd "
             ├─1943 /var/lib/rancher/k3s/data/86a616cdaf0fb57fa13670ac5a16f1699f4b2be4772e842d97904c69698ffdc2/bin/containerd-shim-runc-v2 -namespace k8s.io -id c0eaf8625f0e7ce511cbbfd8c16fa034215c206b649bf3e2cd25cd5342a28d86 -address /run/k3s/containerd/containerd.sock
             ├─2076 /var/lib/rancher/k3s/data/86a616cdaf0fb57fa13670ac5a16f1699f4b2be4772e842d97904c69698ffdc2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 8c83bc27fa5dd6d96c93f5a66298c06e86eba7dedc26924c54461a1245f07f4c -address /run/k3s/containerd/containerd.sock
             ├─2150 /var/lib/rancher/k3s/data/86a616cdaf0fb57fa13670ac5a16f1699f4b2be4772e842d97904c69698ffdc2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 348f88bb7ff68fe40a839b21fc0d45e07cf37940099671a573417ebcf5725841 -address /run/k3s/containerd/containerd.sock
             ├─2233 /var/lib/rancher/k3s/data/86a616cdaf0fb57fa13670ac5a16f1699f4b2be4772e842d97904c69698ffdc2/bin/containerd-shim-runc-v2 -namespace k8s.io -id fa3c250eae23865d562055de5dbccfd033c5ae8980188cf5f732ff10b50a285c -address /run/k3s/containerd/containerd.sock
             └─2321 /var/lib/rancher/k3s/data/86a616cdaf0fb57fa13670ac5a16f1699f4b2be4772e842d97904c69698ffdc2/bin/containerd-shim-runc-v2 -namespace k8s.io -id cd586e7ebd5f1c8c0a38f3991ba3192445f5a722568ab5ba763dfdcb4f8f16ff -address /run/k3s/containerd/containerd.sock

vultr ~ # kubectl get nodes
NAME          STATUS   ROLES                  AGE   VERSION
vultr.guest   Ready    control-plane,master   28m   v1.33.5+k3s1

vultr ~ # ls -l /opt/bin/
total 72592
-rwxr-xr-x. 1 root root 74322104 Nov  8 19:52 k3s
-rwxr-xr-x. 1 root root     2318 Nov  8 19:52 k3s-killall.sh
-rwxr-xr-x. 1 root root     1975 Nov  8 19:52 k3s-uninstall.sh
lrwxrwxrwx. 1 root root        3 Nov  8 19:52 kubectl -> k3s
```

## OS updates

Refs:

- https://www.flatcar.org/docs/latest/setup/releases/update-strategies/
- https://www.flatcar.org/docs/latest/tutorial/hands-on-4/
- https://www.flatcar.org/docs/latest/nebraska/
- https://github.com/flatcar/locksmith

### OS updates: useful commands

- `cat /proc/cmdline` → ...BOOT_IMAGE=/flatcar/vmlinuz-a...
- `systemctl status update-engine.service locksmithd.service`
- `cat /etc/os-release`
- `update_engine_client -check_for_update`
- `update_engine_client -update`
- `flatcar-update -V 4230.2.4`

### OS updates: example

Example: **sda3=USR-A (current)** and **sda4=USR-B**:
```
localhost ~ # lsblk -o NAME,LABEL,PARTLABEL,MOUNTPOINT
NAME    LABEL      PARTLABEL  MOUNTPOINT
loop2
loop3
sda
|-sda1  EFI-SYSTEM EFI-SYSTEM /boot
|-sda2             BIOS-BOOT
|-sda3             USR-A
| `-usr                       /usr
|-sda4             USR-B
|-sda6  OEM        OEM        /oem
|-sda7             OEM-CONFIG
`-sda9  ROOT       ROOT       /
```
os-release (current, USR-A):
```
localhost ~ # ls -l /etc/os-release
lrwxrwxrwx. 1 root root 21 Nov 10 14:32 /etc/os-release -> ../usr/lib/os-release

localhost ~ # cat /etc/os-release
NAME="Flatcar Container Linux by Kinvolk"
ID=flatcar
ID_LIKE=coreos
VERSION=4459.2.0
VERSION_ID=4459.2.0
BUILD_ID=2025-11-10-1432
SYSEXT_LEVEL=1.0
PRETTY_NAME="Flatcar Container Linux by Kinvolk 4459.2.0 (Oklo)"
ANSI_COLOR="38;5;75"
HOME_URL="https://flatcar.org/"
BUG_REPORT_URL="https://issues.flatcar.org"
FLATCAR_BOARD="amd64-usr"
CPE_NAME="cpe:2.3:o:flatcar-linux:flatcar_linux:4459.2.0:*:*:*:*:*:*:*"
```
os-release (inactive, USR-B):
```
localhost ~ # mkdir /mnt4

localhost ~ # mount -o ro /dev/sda4 /mnt4

localhost ~ # cat /mnt4/lib/os-release
NAME="Flatcar Container Linux by Kinvolk"
ID=flatcar
ID_LIKE=coreos
VERSION=4230.2.4
VERSION_ID=4230.2.4
BUILD_ID=2025-10-12-2304
SYSEXT_LEVEL=1.0
PRETTY_NAME="Flatcar Container Linux by Kinvolk 4230.2.4 (Oklo)"
ANSI_COLOR="38;5;75"
HOME_URL="https://flatcar.org/"
BUG_REPORT_URL="https://issues.flatcar.org"
FLATCAR_BOARD="amd64-usr"
CPE_NAME="cpe:2.3:o:flatcar-linux:flatcar_linux:4230.2.4:*:*:*:*:*:*:*"
```

### OS updates: FAQ

https://www.flatcar.org/faq

(...)

**If the image is immutable, how does it get updated?**

Flatcar uses the **USR-A** and **USR-B** update mechanism, first introduced by ChromeOS. There are two partitions where the **/usr/** filesystem can be deployed. One of them is used as the active **/usr** filesystem, while the other stays in stand-by.

When a new Flatcar Container Linux version is released, the update payload is deployed to the inactive **/usr/** partition. The next time the machine reboots, it mounts this other partition and boots into a fully updated system.

If for any reason something goes wrong during the boot process, the system automatically falls back to the previous **/usr/** partition.
(...)

https://www.flatcar.org/docs/latest/installing/
(...)
**On automatic updates**
Flatcar has automatic updates enabled by default. Flatcar instances will download and stage (in the background) new OS versions as well as reboot into the updated OS when a new update becomes available. To change this default - for instance, to define reboot windows or even disable reboots - check out the [update strategies](https://www.flatcar.org/docs/latest/setup/releases/update-strategies/) doc. To disable downloading updates altogether either disable the update-engine service via a user-supplied systemd config, or use an invalid URL in the SERVER field of [update.conf](https://www.flatcar.org/docs/latest/setup/releases/update-conf/) .
(...)

## (OLD) Install (VirtualBox)

Ref: https://www.flatcar.org/docs/latest/installing/vms/virtualbox/

**(1)** Create virtual disk:
```
$ wget https://raw.githubusercontent.com/flatcar/scripts/main/contrib/create-coreos-vdi

$ bash create-coreos-vdi -h
Usage: create-coreos-vdi [-V version] [-d /target/path]
Options:
    -d DEST     Create Flatcar VDI image to the given path.
    -V VERSION  Version to install (e.g. alpha) [default: stable]
    -h          This help

This tool creates a Flatcar VDI image to be used with VirtualBox.

$ bash create-coreos-vdi -V stable -d /vps

$ ls -l /vps/flatcar_production_4230.2.4.vdi 
-rw------- 1 sfm sfm 737148928 Nov  6 19:50 /vps/flatcar_production_4230.2.4.vdi
```

**(2)** Create config drive:
```
$ wget https://raw.github.com/flatcar/scripts/main/contrib/create-basic-configdrive

$ bash create-basic-configdrive -H my_vm01 -S ~/.ssh/id_rsa.pub -p /vps

$ ls -l /vps/my_vm01.iso
-rw------- 1 sfm sfm 364544 Nov  6 19:57 /vps/my_vm01.iso
```

**my_vm01.iso** details (one file: **openstack/latest/user_data**):
```
$ flatcar sudo mount -o ro my_vm01.iso /mnt4

$ flatcar find /mnt4 -type f
/mnt4/openstack/latest/user_data

$ cat /mnt4/openstack/latest/user_data
#cloud-config

coreos:
  etcd2:
    name: my_vm01
    advertise-client-urls: http://$public_ipv4:2379
    initial-advertise-peer-urls: http://$private_ipv4:2380
    discovery: https://discovery.etcd.io/TOKEN
    listen-peer-urls: http://0.0.0.0:2380
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
  units:
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
ssh_authorized_keys:
  - ssh-rsa AAAA...
hostname: my_vm01

$ sudo umount /mnt4
```

**(3)** Clone disk:
```
$ VBoxManage clonehd /vps/flatcar_production_4230.2.4.vdi /vps/my_vm01.vdi

$ VBoxManage modifyhd /vps/my_vm01.vdi --resize 8192
```

**(4)** Start VirtualBox:

- HDD: /vps/my_vm01.vdi
- ISO: /vps/my_vm01.iso
- 2G RAM

**(5)** Login:
```
$ ssh core@192.168.56.14
(...)
core@myvm01 ~ $ 
```

### (OLD) user-configdrive.service

```
$ ssh core@192.168.56.14

core@myvm01 ~ $ systemctl cat user-configdrive.service
# /usr/lib/systemd/system/user-configdrive.service
[Unit]
Description=Load cloud-config from /media/configdrive
Requires=flatcar-setup-environment.service
After=flatcar-setup-environment.service system-config.target
Before=user-config.target

# HACK: work around ordering between config drive and ec2 metadata It is
# possible for OpenStack style systems to provide both the metadata service
# and config drive, to prevent the two from stomping on each other, force
# this to run after OEM and after metadata (if it exsts). I'm doing this
# here instead of in the oem service because the oem unit is not written
# to disk until the OEM cloud config is evaluated and I want to make sure
# systemd knows about the ordering as early as possible.
# coreos-cloudinit could implement a simple lock but that cannot be used
# until after the systemd dbus calls are made non-blocking.
After=enable-oem-cloudinit.service oem-cloudinit.service

# Skip on clouds that are covered by flatcar/init:systemd/system/oem-cloudinit.service
ConditionKernelCommandLine=!flatcar.oem.id=digitalocean
ConditionKernelCommandLine=!coreos.oem.id=digitalocean
ConditionKernelCommandLine=!coreos.oem.id=openstack
ConditionKernelCommandLine=!flatcar.oem.id=openstack
[Service]
Type=oneshot
ExecCondition=/usr/bin/bash -c "if [ -f '/etc/.ignition-result.json' ] && /usr/bin/jq -e '.userConfigProvided == true' /etc/.ignition-result.json; then exit 1; fi"
TimeoutSec=10min
RemainAfterExit=yes
EnvironmentFile=-/etc/environment
ExecStart=/usr/bin/coreos-cloudinit --from-configdrive=/media/configdrive
```

### (OLD) coreos-cloudinit

Useful for testing on VirtualBox:

- Host: `busybox httpd -p 192.168.56.1:8080 -f -v`
- VM: `core@myvm01 ~ $ sudo coreos-cloudinit --from-url=http://192.168.56.1:8080/install.yaml`

```
$ ssh core@192.168.56.14

core@myvm01 ~ $ coreos-cloudinit -h
Usage of coreos-cloudinit:
  -convert-netconf string
    	Read the network config provided in cloud-drive and translate it from the specified format into networkd unit files
  -from-cloudsigma-metadata
    	Download data from CloudSigma server context
  -from-configdrive string
    	Read data from provided cloud-drive directory
  -from-digitalocean-metadata string
    	Download DigitalOcean data from the provided url
  -from-ec2-metadata string
    	Download EC2 data from the provided url
  -from-file string
    	Read user-data from provided file
  -from-gce-metadata string
    	Download GCE data from the provided url
  -from-metadata-service
    	[DEPRECATED - Use -from-ec2-metadata] Download data from metadata service
  -from-packet-metadata string
    	Download Packet data from metadata service
  -from-proc-cmdline
    	Parse /proc/cmdline for 'cloud-config-url=<url>', using the cloud-config served by an HTTP GET to <url>
  -from-url string
    	Download user-data from provided url
  -from-vmware-guestinfo
    	Read data from VMware guestinfo
  -from-vmware-ovf-env string
    	Read data from OVF Environment
  -from-waagent string
    	Read data from provided waagent directory
  -ignore-failure
    	Exits with 0 status in the event of malformed input from user-data
  -oem string
    	Use the settings specific to the provided OEM
  -ssh-key-name string
    	Add SSH keys to the system with the given name (default "coreos-cloudinit")
  -validate
    	[EXPERIMENTAL] Validate the user-data but do not apply it to the system
  -version
    	Print the version and exit
  -workspace string
    	Base directory coreos-cloudinit should use to store data (default "/var/lib/coreos-cloudinit")
```
