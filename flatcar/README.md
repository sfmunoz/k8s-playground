# flatcar

- [References](#references)
- [Config systems](#config-systems)
- [Butane vs Ignition](#butane-vs-ignition)
- [Install (VirtualBox)](#install-virtualbox)
  - [user-configdrive.service](#user-configdriveservice)
  - [coreos-cloudinit](#coreos-cloudinit)

## References

- https://www.flatcar.org/
- https://www.flatcar.org/docs/latest/installing/

## Config systems

Recap:

- Now: **Butane + Ignition**
  - **Butane**: successor of **Container Linux Config**
- Old: **cloud-config**

https://www.flatcar.org/docs/latest/installing/
(...)
Flatcar Container Linux is configured at provisioning time. There are two configuration languages to set up Flatcar, aimed at different use cases:

- [Butane Config](https://www.flatcar.org/docs/latest/provisioning/config-transpiler/) Butane is human-readable / writable YAML and must be converted (transpiled) into Ignition V3 config before Flatcar can use it. It’s the successor of [Container Linux Config](https://www.flatcar.org/docs/latest/provisioning/cl-config/) which is also still supported (Butane is not supported for LTS-2022).
- [Ignition config](https://www.flatcar.org/docs/latest/provisioning/ignition/) is machine-readable JSON fed to Flatcar’s ignition service. Ignition is Flatcars “installation service” which configures a Flatcar instance during provisioning. The config file is passed via the “custom data” or “user data” option of cloud providers, and can be supplied by various mechanisms to private cloud VMs and bare metal. Ignition config is rarely written by a human; it’s usually generated by provisioning automation or transpiled from user-written Butane.
(...)

https://www.flatcar.org/docs/latest/provisioning/cl-config/
(...)
Previously, the recommended way to provision a Flatcar Container Linux machine was with a cloud-config. These configs would be given to a Flatcar Container Linux machine and a utility called [coreos-cloudinit](https://github.com/kinvolk/coreos-cloudinit) would read this file and apply the configuration on every boot.

For a [number of reasons](https://www.flatcar.org/docs/latest/provisioning/ignition/#ignition-vs-coreos-cloudinit), coreos-cloudinit has been deprecated in favor of Container Linux Configs and Ignition. For help migrating from these legacy cloud-configs to Container Linux Configs, refer to the [migration guide](https://www.flatcar.org/docs/latest/provisioning/cl-config/from-cloud-config/).
(...)

## Butane vs Ignition

Ref: https://www.flatcar.org/docs/latest/installing/

**cl.yaml**:
```yaml
variant: flatcar
version: 1.0.0
systemd:
  units:
    - name: nginx.service
      enabled: true
      contents: |
        [Unit]
        Description=NGINX example
        After=docker.service
        Requires=docker.service
        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker rm --force nginx1
        ExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1
        ExecStop=/usr/bin/docker stop nginx1
        Restart=always
        RestartSec=5s
        [Install]
        WantedBy=multi-user.target
```

Butane → Ignition:
```
cat cl.yaml | docker run --rm -i quay.io/coreos/butane:latest > ignition.json
```

`jq . < ignition.json`:
```json
{
  "ignition": {
    "version": "3.3.0"
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=NGINX example\nAfter=docker.service\nRequires=docker.service\n[Service]\nTimeoutStartSec=0\nExecStartPre=-/usr/bin/docker rm --force nginx1\nExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1\nExecStop=/usr/bin/docker stop nginx1\nRestart=always\nRestartSec=5s\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "nginx.service"
      }
    ]
  }
}
```

contents:
```
jq -r '.systemd.units[0].contents' < ignition.json
[Unit]
Description=NGINX example
After=docker.service
Requires=docker.service
[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker rm --force nginx1
ExecStart=/usr/bin/docker run --name nginx1 --pull always --log-driver=journald --net host docker.io/nginx:1
ExecStop=/usr/bin/docker stop nginx1
Restart=always
RestartSec=5s
[Install]
WantedBy=multi-user.target
```

## Install (VirtualBox)

Ref: https://www.flatcar.org/docs/latest/installing/vms/virtualbox/

**(1)** Create virtual disk:
```
$ wget https://raw.githubusercontent.com/flatcar/scripts/main/contrib/create-coreos-vdi

$ bash create-coreos-vdi -h
Usage: create-coreos-vdi [-V version] [-d /target/path]
Options:
    -d DEST     Create Flatcar VDI image to the given path.
    -V VERSION  Version to install (e.g. alpha) [default: stable]
    -h          This help

This tool creates a Flatcar VDI image to be used with VirtualBox.

$ bash create-coreos-vdi -V stable -d /vps

$ ls -l /vps/flatcar_production_4230.2.4.vdi 
-rw------- 1 sfm sfm 737148928 Nov  6 19:50 /vps/flatcar_production_4230.2.4.vdi
```

**(2)** Create config drive:
```
$ wget https://raw.github.com/flatcar/scripts/main/contrib/create-basic-configdrive

$ bash create-basic-configdrive -H my_vm01 -S ~/.ssh/id_rsa.pub -p /vps

$ ls -l /vps/my_vm01.iso
-rw------- 1 sfm sfm 364544 Nov  6 19:57 /vps/my_vm01.iso
```

**my_vm01.iso** details (one file: **openstack/latest/user_data**):
```
$ flatcar sudo mount -o ro my_vm01.iso /mnt4

$ flatcar find /mnt4 -type f
/mnt4/openstack/latest/user_data

$ cat /mnt4/openstack/latest/user_data
#cloud-config

coreos:
  etcd2:
    name: my_vm01
    advertise-client-urls: http://$public_ipv4:2379
    initial-advertise-peer-urls: http://$private_ipv4:2380
    discovery: https://discovery.etcd.io/TOKEN
    listen-peer-urls: http://0.0.0.0:2380
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
  units:
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
ssh_authorized_keys:
  - ssh-rsa AAAA...
hostname: my_vm01

$ sudo umount /mnt4
```

**(3)** Clone disk:
```
$ VBoxManage clonehd /vps/flatcar_production_4230.2.4.vdi /vps/my_vm01.vdi

$ VBoxManage modifyhd /vps/my_vm01.vdi --resize 8192
```

**(4)** Start VirtualBox:

- HDD: /vps/my_vm01.vdi
- ISO: /vps/my_vm01.iso
- 2G RAM

**(5)** Login:
```
$ ssh core@192.168.56.14
(...)
core@myvm01 ~ $ 
```

### user-configdrive.service

```
$ ssh core@192.168.56.14

core@myvm01 ~ $ systemctl cat user-configdrive.service
# /usr/lib/systemd/system/user-configdrive.service
[Unit]
Description=Load cloud-config from /media/configdrive
Requires=flatcar-setup-environment.service
After=flatcar-setup-environment.service system-config.target
Before=user-config.target

# HACK: work around ordering between config drive and ec2 metadata It is
# possible for OpenStack style systems to provide both the metadata service
# and config drive, to prevent the two from stomping on each other, force
# this to run after OEM and after metadata (if it exsts). I'm doing this
# here instead of in the oem service because the oem unit is not written
# to disk until the OEM cloud config is evaluated and I want to make sure
# systemd knows about the ordering as early as possible.
# coreos-cloudinit could implement a simple lock but that cannot be used
# until after the systemd dbus calls are made non-blocking.
After=enable-oem-cloudinit.service oem-cloudinit.service

# Skip on clouds that are covered by flatcar/init:systemd/system/oem-cloudinit.service
ConditionKernelCommandLine=!flatcar.oem.id=digitalocean
ConditionKernelCommandLine=!coreos.oem.id=digitalocean
ConditionKernelCommandLine=!coreos.oem.id=openstack
ConditionKernelCommandLine=!flatcar.oem.id=openstack
[Service]
Type=oneshot
ExecCondition=/usr/bin/bash -c "if [ -f '/etc/.ignition-result.json' ] && /usr/bin/jq -e '.userConfigProvided == true' /etc/.ignition-result.json; then exit 1; fi"
TimeoutSec=10min
RemainAfterExit=yes
EnvironmentFile=-/etc/environment
ExecStart=/usr/bin/coreos-cloudinit --from-configdrive=/media/configdrive
```

### coreos-cloudinit

Useful for testing on VirtualBox:

- Host: `busybox httpd -p 192.168.56.1:8080 -f -v`
- VM: `core@myvm01 ~ $ sudo coreos-cloudinit --from-url=http://192.168.56.1:8080/install.yaml`

```
$ ssh core@192.168.56.14

core@myvm01 ~ $ coreos-cloudinit -h
Usage of coreos-cloudinit:
  -convert-netconf string
    	Read the network config provided in cloud-drive and translate it from the specified format into networkd unit files
  -from-cloudsigma-metadata
    	Download data from CloudSigma server context
  -from-configdrive string
    	Read data from provided cloud-drive directory
  -from-digitalocean-metadata string
    	Download DigitalOcean data from the provided url
  -from-ec2-metadata string
    	Download EC2 data from the provided url
  -from-file string
    	Read user-data from provided file
  -from-gce-metadata string
    	Download GCE data from the provided url
  -from-metadata-service
    	[DEPRECATED - Use -from-ec2-metadata] Download data from metadata service
  -from-packet-metadata string
    	Download Packet data from metadata service
  -from-proc-cmdline
    	Parse /proc/cmdline for 'cloud-config-url=<url>', using the cloud-config served by an HTTP GET to <url>
  -from-url string
    	Download user-data from provided url
  -from-vmware-guestinfo
    	Read data from VMware guestinfo
  -from-vmware-ovf-env string
    	Read data from OVF Environment
  -from-waagent string
    	Read data from provided waagent directory
  -ignore-failure
    	Exits with 0 status in the event of malformed input from user-data
  -oem string
    	Use the settings specific to the provided OEM
  -ssh-key-name string
    	Add SSH keys to the system with the given name (default "coreos-cloudinit")
  -validate
    	[EXPERIMENTAL] Validate the user-data but do not apply it to the system
  -version
    	Print the version and exit
  -workspace string
    	Base directory coreos-cloudinit should use to store data (default "/var/lib/coreos-cloudinit")
```
